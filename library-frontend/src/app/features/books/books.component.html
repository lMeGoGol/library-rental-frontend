<section class="books">
  <div class="section-title">üìö –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥</div>
  <div class="search-bar">
    <input type="text" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é / –∞–≤—Ç–æ—Ä–æ–º / –∂–∞–Ω—Ä–æ–º..." (input)="onSearch($event.target.value)" />
    <a routerLink="/books/new" class="btn outline" *appHasRole="['admin','librarian']">‚ûï –î–æ–¥–∞—Ç–∏</a>
  </div>
  <div class="card filters-bar">
    <label>–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è:</label>
    <select [value]="sortBy" (change)="setSort(($any($event.target)).value)">
      <option value="title">–ù–∞–∑–≤–∞</option>
      <option value="author">–ê–≤—Ç–æ—Ä</option>
      <option value="rentPrice">–û—Ä–µ–Ω–¥–∞/–¥–µ–Ω—å</option>
      <option value="createdAt">–î–æ–¥–∞–Ω–æ</option>
    </select>
    <button class="btn outline" (click)="toggleDir()">–ù–∞–ø—Ä—è–º–æ–∫: {{ sortDir==='asc' ? '‚¨Ü' : '‚¨á' }}</button>
  </div>

  <div *ngIf="loading" class="card loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
  <div *ngIf="!loading && error" class="card error-text">{{ error }}</div>
  <div *ngIf="!loading && books.length === 0" class="card empty">–ù–µ–º–∞—î –∫–Ω–∏–≥</div>

  <div *ngIf="!loading && books.length > 0" class="card card-table">
    <div class="table-scroll-x">
    <table class="lib-table no-margin">
      <thead>
        <tr>
          <th>ID</th>
          <th>–û–±–∫–ª–∞–¥–∏–Ω–∫–∞</th>
          <th>–ù–∞–∑–≤–∞</th>
          <th>–ê–≤—Ç–æ—Ä</th>
          <th>–ñ–∞–Ω—Ä</th>
          <th>–û—Ä–µ–Ω–¥–∞/–¥–µ–Ω—å</th>
          <th>–ó–∞—Å—Ç–∞–≤–∞</th>
          <th>–ù–∞—è–≤–Ω—ñ—Å—Ç—å</th>
          <th *ngIf="isEditor">–°—Ç–∞—Ç—É—Å</th>
          <th class="col-actions">–î—ñ—ó</th>
        </tr>
      </thead>
      <tbody>
  <tr *ngFor="let book of books; trackBy: trackById" (click)="onRowClick(book, $event)" [class.row-click]="isEditor" [class.unavailable]="book.availableCount === 0">
          <td class="col-id">
            <span class="mono" [title]="book.id">{{ formatId(book.id) }}</span>
            <button class="btn compact outline" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ ID" (click)="copyId($event, book.id)">üìã</button>
          </td>
          <td>
            <img *ngIf="book.thumbnailUrl" [src]="book.thumbnailUrl" alt="cover" class="thumb" />
          </td>
          <td>
            <strong>{{ book.title }}</strong>
            <div class="small muted" *ngIf="book.isReserved && book.reservedUntil as ru">–î–æ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è: {{ getReserveRemaining(ru) }}</div>
          </td>
          <td>{{ book.author }}</td>
          <td><span class="badge primary">{{ book.genre }}</span></td>
          <td>‚Ç¥{{ book.rentPrice }}</td>
          <td>‚Ç¥{{ book.deposit }}</td>
          <td>
            <ng-container *ngIf="book.quantity != null && book.availableCount != null; else unknown">
              <ng-container *ngIf="book.isReserved && book.quantity === 1; else normalCount">0 / 1</ng-container>
              <ng-template #normalCount>{{ book.availableCount }} / {{ book.quantity }}</ng-template>
            </ng-container>
            <ng-template #unknown>‚Äî</ng-template>
          </td>
          <td *ngIf="isEditor">
            <span class="badge" [class.danger]="!book.available && !book.isReserved" [class.warn]="book.isReserved" [class.success]="book.available && !book.isReserved">
              {{ book.isReserved ? '–∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–∞' : (book.available ? '–¥–æ—Å—Ç—É–ø–Ω–∞' : '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') }}
            </span>
          </td>
          <td class="col-actions">
            <div class="row-actions">
              <button class="btn danger" *appHasRole="['admin','librarian']" (click)="delete(book); $event.stopPropagation()">‚úñ –í–∏–¥–∞–ª–∏—Ç–∏</button>
              <button class="btn" *appHasRole="'reader'" (click)="reserve(book); $event.stopPropagation()" [disabled]="book.isReserved || book.availableCount === 0" [class.disabled-btn]="book.isReserved || book.availableCount === 0">üîî –†–µ–∑–µ—Ä–≤</button>
              <ng-container *ngIf="book.isReserved">
                <button class="btn outline" *appHasRole="['admin','librarian']" (click)="release(book); $event.stopPropagation()">üîì –ó–Ω—è—Ç–∏ –±—Ä–æ–Ω—å</button>
              </ng-container>
            </div>
          </td>
        </tr>
      </tbody>
  </table>
  </div>
  <app-pager [page]="page" [limit]="pageSize" [total]="total" [pages]="totalPages" (prev)="prevPage()" (next)="nextPage()" />
  </div>
</section>