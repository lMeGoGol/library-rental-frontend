<section class="card" *ngIf="user">
  <h2 class="mt-0">–ü—Ä–æ—Ñ—ñ–ª—å</h2>
  <form *ngIf="form" [formGroup]="form" class="form-grid" (ngSubmit)="save()">
    <div class="two-col">
      <div class="col-left">
        <label>
          <span>–ü—Ä—ñ–∑–≤–∏—â–µ</span>
          <input formControlName="lastName" type="text" />
        </label>
        <label>
          <span>–Ü–º º—è</span>
          <input formControlName="firstName" type="text" />
        </label>
        <label>
          <span>–ü–æ-–±–∞—Ç—å–∫–æ–≤—ñ</span>
          <input formControlName="middleName" type="text" />
        </label>
        <label>
          <span>–ê–¥—Ä–µ—Å–∞</span>
          <input formControlName="address" type="text" />
        </label>
        <label>
          <span>–¢–µ–ª–µ—Ñ–æ–Ω</span>
          <input formControlName="phone" type="text" />
        </label>
        <div class="full"><h3 class="section-title">–ó–º—ñ–Ω–∞ –ø–∞—Ä–æ–ª—é</h3></div>
        <div class="full full-reset" *ngIf="isSelf">
          <label>
            <span>–ü–æ—Ç–æ—á–Ω–∏–π –ø–∞—Ä–æ–ª—å</span>
            <input [(ngModel)]="currentPwd" [ngModelOptions]="{standalone:true}" type="password" />
          </label>
        </div>
        <div class="full full-reset">
          <label>
            <span>–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</span>
            <input [(ngModel)]="newPwd" [ngModelOptions]="{standalone:true}" type="password" />
          </label>
        </div>
        <div class="full">
          <div class="row">
            <button class="btn btn-save-discount" type="button" (click)="changePassword()" [disabled]="changingPwd">–ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
          </div>
        </div>
      </div>
      <div class="col-right">
        <div class="info-row key"><strong>ID:</strong> <span class="mono" [title]="user.id">{{ user.id }}</span></div>
        <div class="info-row key"><strong>–õ–æ–≥—ñ–Ω:</strong> {{ user.username }}</div>
        <div class="info-row key role-row">
          <strong>–†–æ–ª—å:</strong>
          <ng-container *ngIf="isStaff && !isSelf && user?.role!=='reader'; else roleView">
            <select class="input" [(ngModel)]="roleDraft" [ngModelOptions]="{standalone:true}">
              <option value="reader">—á–∏—Ç–∞—á</option>
              <option value="librarian">–±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞—Ä</option>
              <option value="admin">–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</option>
            </select>
            <div class="role-actions">
              <button class="btn compact" type="button" (click)="saveRole()" [disabled]="savingRole">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–æ–ª—å</button>
              <span class="saved" *ngIf="savedRole">–ó–±–µ—Ä–µ–∂–µ–Ω–æ ‚úì</span>
            </div>
          </ng-container>
          <ng-template #roleView>{{ user.role === 'admin' ? '–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä' : (user.role === 'librarian' ? '–±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞—Ä' : '—á–∏—Ç–∞—á') }}</ng-template>
        </div>

        <ng-container *ngIf="user.discountCategory && user.discountCategory !== 'none'">
          <div class="profile-box mt-05">
            <h3 class="box-title">–ü–æ—Ç–æ—á–Ω–∞ –∑–Ω–∏–∂–∫–∞</h3>
            <div class="discount-tag">
              {{ user.discountCategory === 'student' ? '—Å—Ç—É–¥–µ–Ω—Ç' : (user.discountCategory === 'loyal' ? '–ª–æ—è–ª—å–Ω–∏–π' : (user.discountCategory === 'pensioner' ? '–ø–µ–Ω—Å—ñ–æ–Ω–µ—Ä' : (user.discountCategory === 'vip' ? 'VIP' : ''))) }}
            </div>
            <div class="muted">–ó–Ω–∏–∂–∫–∞ –Ω–∞ –æ—Ä–µ–Ω–¥—É: {{ user.discountCategory === 'student' ? '20%' : (user.discountCategory === 'loyal' ? '15%' : (user.discountCategory === 'pensioner' ? '50%' : (user.discountCategory === 'vip' ? '30%' : '0%'))) }}.</div>
          </div>
        </ng-container>

        <div *ngIf="canEditDiscount" class="profile-box mt-05">
          <h3 class="box-title">–ó–º—ñ–Ω–∏—Ç–∏ –∑–Ω–∏–∂–∫—É</h3>
          <label class="mb-sm"><span>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</span>
            <select class="input" [(ngModel)]="discountDraft" [ngModelOptions]="{standalone: true}" name="discountForUser">
              <option value="none">–±–µ–∑ –∑–Ω–∏–∂–∫–∏</option>
              <option value="student">—Å—Ç—É–¥–µ–Ω—Ç</option>
              <option value="loyal">–ª–æ—è–ª—å–Ω–∏–π</option>
              <option value="pensioner">–ø–µ–Ω—Å—ñ–æ–Ω–µ—Ä</option>
              <option value="vip">VIP</option>
            </select>
          </label>
          <div class="muted small">–ü—ñ–¥–∫–∞–∑–∫–∞: —Å—Ç—É–¥–µ–Ω—Ç ‚Äî 20%, –ª–æ—è–ª—å–Ω–∏–π ‚Äî 15%, –ø–µ–Ω—Å—ñ–æ–Ω–µ—Ä ‚Äî 50%, VIP ‚Äî 30%.</div>
          <div class="row mt-05">
            <button class="btn btn-save-discount" type="button" (click)="saveDiscount()" [disabled]="savingDiscount">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–Ω–∏–∂–∫—É</button>
            <span *ngIf="savedDiscount" class="saved">–ó–±–µ—Ä–µ–∂–µ–Ω–æ ‚úì</span>
          </div>
        </div>
      </div>
    </div>


    <div class="form-actions">
      <button class="btn btn-save-discount" type="submit" [disabled]="saving">üíæ {{ saving ? '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...' : '–ó–±–µ—Ä–µ–≥—Ç–∏' }}</button>
      <button class="btn outline" type="button" (click)="goBack()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  <!-- Removed duplicate '–ú–æ—ó –ø–æ–∑–∏–∫–∏' button (available in main menu) -->
      <span *ngIf="saved" class="saved">–ó–±–µ—Ä–µ–∂–µ–Ω–æ ‚úì</span>
    </div>
  </form>
</section>
<div *ngIf="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

<section *ngIf="showHistory && user?.role==='reader'" class="card mt-section">
  <h3 class="mt-0">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–∑–∏–∫</h3>
  <div *ngIf="!history?.length" class="muted">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</div>
  <div *ngIf="history?.length" class="card-table">
    <table class="lib-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>–ö–Ω–∏–≥–∞</th>
          <th>–í–∏–¥–∞–Ω–æ</th>
          <th>–ü–æ–≤–µ—Ä–Ω—É—Ç–æ</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th *ngIf="user?.role!=='reader'">–î–µ—Ç–∞–ª—ñ</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let h of history">
          <td class="id-col"><span class="mono" [title]="h.id">{{ formatId(h.id) }}</span></td>
          <td>{{ displayBook(h.book) }}</td>
          <td>{{ h.issueDate | date:'shortDate' }}</td>
          <td>{{ h.actualReturnDate ? (h.actualReturnDate | date:'shortDate') : '‚Äî' }}</td>
          <td><span class="badge" [class.success]="h.status==='returned'" [class.warn]="h.status==='issued'">{{ h.status === 'issued' ? '–≤–∏–¥–∞–Ω–æ' : (h.status === 'returned' ? '–ø–æ–≤–µ—Ä–Ω–µ–Ω–æ' : h.status) }}</span></td>
          <td *ngIf="user?.role!=='reader'">
            <div class="muted small">
              ‚Ç¥/–¥–µ–Ω—å: {{ h.rentPerDay }}; –¥–Ω—ñ–≤: {{ h.days }}; —Å—É–º–∞: ‚Ç¥{{ h.totalRent }}; –∑–∞—Å—Ç–∞–≤–∞: ‚Ç¥{{ h.deposit }}
              <span *ngIf="h.penalty && h.penalty>0">; —à—Ç—Ä–∞—Ñ: ‚Ç¥{{ h.penalty }}</span>
              <span *ngIf="h.damageFee && h.damageFee>0">; –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è: ‚Ç¥{{ h.damageFee }}</span>
              <span *ngIf="h.discountCategory && h.discountCategory!=='none'">; –∑–Ω–∏–∂–∫–∞: {{ h.discountCategory }} ({{ h.discountPercent || 0 }}%)</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<section *ngIf="showReservations && isStaff && user?.role==='reader'" class="card mt-section">
  <h3 class="mt-0">–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h3>
  <div class="toolbar mb-05">
    <label>–°—Ç–∞—Ç—É—Å:
      <select (change)="setReservationsStatus(($any($event.target)).value || '')">
        <option value="pending" [selected]="reservationsStatus==='pending'">–û—á—ñ–∫—É—î</option>
        <option value="fulfilled" [selected]="reservationsStatus==='fulfilled'">–í–∏–∫–æ–Ω–∞–Ω–æ</option>
        <option value="cancelled" [selected]="reservationsStatus==='cancelled'">–°–∫–∞—Å–æ–≤–∞–Ω–æ</option>
        <option value="" [selected]="reservationsStatus===''">–£—Å—ñ</option>
      </select>
    </label>
  </div>
  <div *ngIf="reservationsLoading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
  <div *ngIf="!reservationsLoading && !reservations.length" class="muted">–ù–µ–º–∞—î –±—Ä–æ–Ω—é–≤–∞–Ω—å</div>
  <div *ngIf="!reservationsLoading && reservations.length" class="card-table">
    <table class="lib-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>–ö–Ω–∏–≥–∞</th>
          <th>–î–Ω—ñ</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–î—ñ—ó</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of reservations">
          <td class="mono" [title]="r.id">{{ formatId(r.id) }}</td>
          <td>{{ (typeof r.book==='string' ? r.book : r.book.title) || '-' }}</td>
          <td>{{ r.desiredDays }}</td>
          <td><span class="badge" [class.warn]="r.status==='pending'" [class.success]="r.status==='fulfilled'" [class.danger]="r.status==='cancelled'">{{ r.status==='pending' ? '–æ—á—ñ–∫—É—î' : (r.status==='fulfilled' ? '–≤–∏–∫–æ–Ω–∞–Ω–æ' : '—Å–∫–∞—Å–æ–≤–∞–Ω–æ') }}</span></td>
          <td class="row-actions">
            <button class="btn compact" (click)="issueReservation(r)" [disabled]="r.status!=='pending'">–í–∏–¥–∞—Ç–∏</button>
            <button class="btn outline compact" (click)="cancelReservation(r)" [disabled]="r.status!=='pending'">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>