<section class="form-panel wide">
  <div class="card">
  <h2 class="title">üìù –í–∏–¥–∞—Ç–∏ –∫–Ω–∏–≥—É</h2>
      <h2 class="title">–í–∏–¥–∞—Ç–∏ –∫–Ω–∏–≥—É</h2>
      <form [formGroup]="form" (ngSubmit)="submit()" class="loan-form">
        <div *ngIf="loadingRef" class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–≤—ñ–¥–Ω–∏–∫—ñ–≤...</div>

        <!-- Pick in sequence: —á–∏—Ç–∞—á -> –∫–Ω–∏–≥–∞ -->
  <div class="pick-lists">
          <div class="card list-card">
            <div class="row between">
              <strong>–ß–∏—Ç–∞—á—ñ</strong>
              <input class="input" type="text" placeholder="–ü–æ—à—É–∫ —á–∏—Ç–∞—á—ñ–≤..." (input)="setReadersSearch($any($event.target).value)" />
            </div>
            <div *ngIf="readersLoading" class="muted small mt-1">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div *ngIf="!readersLoading && !readers.length" class="muted small mt-1">–ù–µ–º–∞—î —á–∏—Ç–∞—á—ñ–≤</div>
            <div class="table-scroll-x" *ngIf="readers.length">
              <table class="lib-table no-margin">
                <thead><tr><th>ID</th><th>–õ–æ–≥—ñ–Ω</th><th>–†–æ–ª—å</th></tr></thead>
                <tbody>
      <tr *ngFor="let u of readers" class="row-click" (click)="pickReader(u)" [class.selected]="form.value.userId===u.id">
                    <td><span class="mono" [title]="u.id">{{ u.id.slice(-6) }}</span></td>
                    <td><a [routerLink]="['/users', u.id, 'profile']" class="user-link" (click)="$event.stopPropagation()">{{ u.username }}</a></td>
                    <td>—á–∏—Ç–∞—á</td>
                  </tr>
                  <tr class="filler" *ngFor="let _ of fillRows(readers.length, readersLimit)"><td colspan="3">&nbsp;</td></tr>
                </tbody>
              </table>
              <div class="pager">
                <button class="btn outline" (click)="prevReaders()" [disabled]="readersPage<=1">–ü–æ–ø–µ—Ä–µ–¥–Ω—è</button>
                <span>–°—Ç–æ—Ä. {{ readersPage }} / {{ readersPages }}</span>
                <button class="btn outline" (click)="nextReaders()" [disabled]="readersPage>=readersPages">–ù–∞—Å—Ç—É–ø–Ω–∞</button>
              </div>
            </div>
          </div>

          <div class="card list-card" *ngIf="form.value.userId as selReader">
            <div class="row between">
              <strong>–î–æ—Å—Ç—É–ø–Ω—ñ –∫–Ω–∏–≥–∏</strong>
              <input class="input" type="text" placeholder="–ü–æ—à—É–∫ –∫–Ω–∏–≥..." (input)="setBooksSearch($any($event.target).value)" />
            </div>
            <div *ngIf="booksLoading" class="muted small mt-1">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div *ngIf="!booksLoading && !booksAvail.length" class="muted small mt-1">–ù–µ–º–∞—î –∫–Ω–∏–≥</div>
            <div class="table-scroll-x" *ngIf="booksAvail.length">
              <table class="lib-table no-margin">
                <thead><tr><th>–ù–∞–∑–≤–∞</th><th>–ê–≤—Ç–æ—Ä</th><th>–ñ–∞–Ω—Ä</th><th>–¶—ñ–Ω–∞/–¥–µ–Ω—å</th><th>–î–æ—Å—Ç—É–ø–Ω–æ</th></tr></thead>
                <tbody>
      <tr *ngFor="let b of booksAvail" class="row-click" (click)="pickBook(b)" [class.selected]="form.value.bookId===b.id">
                    <td>{{ b.title }}</td>
                    <td>{{ b.author }}</td>
                    <td>{{ b.genre }}</td>
                    <td>‚Ç¥{{ b.rentPrice }}</td>
                    <td>{{ b.availableCount ?? (b.available ? 1 : 0) }}</td>
                  </tr>
                  <tr class="filler" *ngFor="let _ of fillRows(booksAvail.length, booksLimit)"><td colspan="5">&nbsp;</td></tr>
                </tbody>
              </table>
              <div class="pager">
                <button class="btn outline" (click)="prevBooks()" [disabled]="booksPage<=1">–ü–æ–ø–µ—Ä–µ–¥–Ω—è</button>
                <span>–°—Ç–æ—Ä. {{ booksPage }} / {{ booksPages }}</span>
                <button class="btn outline" (click)="nextBooks()" [disabled]="booksPage>=booksPages">–ù–∞—Å—Ç—É–ø–Ω–∞</button>
              </div>
            </div>
          </div>
        </div>

  <div class="form-field" *ngIf="form.value.userId && form.value.bookId">
          <div class="row between">
            <div class="mode-switch">
              <button class="chip" type="button" [class.active]="issueMode==='date'" (click)="switchMode('date')">–ó–∞ –¥–∞—Ç–æ—é</button>
              <button class="chip" type="button" [class.active]="issueMode==='days'" (click)="switchMode('days')">–ó–∞ –¥–Ω—è–º–∏</button>
            </div>
            <small class="muted">–Ü–Ω—Ç–µ—Ä–≤–∞–ª 1‚Äì60 –¥–Ω—ñ–≤</small>
          </div>

          <ng-container *ngIf="issueMode==='date'; else daysMode">
            <label class="form-field" [class.invalid]="fieldError('dueDate')">
              –î–∞—Ç–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
              <input type="date" formControlName="dueDate" [min]="minDueDate" [disabled]="issuing" />
              <small class="err" *ngIf="fieldError('dueDate')">{{ fieldError('dueDate') }}</small>
            </label>
          </ng-container>
          <ng-template #daysMode>
            <div class="quick-days">
              <div class="chips">
                <button *ngFor="let d of quickDays" type="button" class="chip" [class.active]="selectedDays===d" (click)="setDays(d)">{{ d }} –¥–Ω.</button>
              </div>
              <div class="days-input-row">
                <label>–í–≤–µ—Å—Ç–∏ –¥–Ω—ñ:
                  <input type="number" min="1" max="60" (input)="onDaysInput(($any($event.target)).value)" [value]="selectedDays || ''" />
                </label>
                <small class="err" *ngIf="daysInputError">{{ daysInputError }}</small>
              </div>
            </div>
          </ng-template>
  </div>

  <div class="muted" *ngIf="!form.value.userId">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —á–∏—Ç–∞—á–∞ –¥–ª—è –≤–∏–¥–∞—á—ñ.</div>
  <div class="muted" *ngIf="form.value.userId && !form.value.bookId">–¢–µ–ø–µ—Ä –æ–±–µ—Ä—ñ—Ç—å –∫–Ω–∏–≥—É –∑—ñ —Å–ø–∏—Å–∫—É.</div>

  <div class="summary pretty" *ngIf="previewDays > 0">
          <div class="pill"><span class="label">–î–Ω—ñ–≤</span><span class="val">{{ previewDays }}</span></div>
          <div class="pill"><span class="label">–ó–Ω–∏–∂–∫–∞</span><span class="val">{{ previewDiscount }}%</span></div>
          <div class="pill"><span class="label">–û—Ä–µ–Ω–¥–∞</span><span class="val">‚Ç¥{{ previewTotalRent }}</span></div>
          <div class="pill"><span class="label">–ó–∞—Å—Ç–∞–≤–∞</span><span class="val">‚Ç¥{{ previewDeposit }}</span></div>
          <div class="total">–î–æ –æ–ø–ª–∞—Ç–∏: <strong>‚Ç¥{{ previewPayableNow }}</strong></div>
        </div>

  <div class="card info" *ngIf="previewDays > 0">
    <div *ngIf="previewDiscount > 0; else noDisc">
      <div><strong>–ë–∞–∑–æ–≤–∞ –æ—Ä–µ–Ω–¥–∞ –±–µ–∑ –∑–Ω–∏–∂–∫–∏:</strong> ‚Ç¥{{ baseRent }}</div>
      <div><strong>–ó–Ω–∏–∂–∫–∞:</strong> {{ previewDiscount }}% (–µ–∫–æ–Ω–æ–º—ñ—è ‚Ç¥{{ baseRent - previewTotalRent }})</div>
      <div><strong>–û—Ä–µ–Ω–¥–∞ –∑—ñ –∑–Ω–∏–∂–∫–æ—é:</strong> ‚Ç¥{{ previewTotalRent }}</div>
    </div>
    <ng-template #noDisc>
      <div><strong>–û—Ä–µ–Ω–¥–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å:</strong> ‚Ç¥{{ previewTotalRent }}</div>
    </ng-template>
  </div>

  <div class="actions">
          <button class="btn" type="submit" [disabled]="issuing || form.invalid">{{ issuing ? '‚åõ' : '‚úÖ' }} {{ issuing ? '–û–±—Ä–æ–±–∫–∞...' : '–í–∏–¥–∞—Ç–∏' }}</button>
          <button type="button" class="btn outline" (click)="goBack()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
  </form>
  </div>
</section>
